### 逆元

#### 1. 定义

如果 $ab \equiv 1 \pmod{p}$，则 $a$ 和 $b$ 在模 $p$ 意义下互为**乘法逆元**。

#### 2. 逆元存在的条件

$gcd(a, p) = 1$

#### 3. 逆元的作用

除法取余: $\frac{a}{b} \bmod p = a \times inv(b) \bmod p$。其中$inv(b)$为 $b$ 在模 $p$ 意义下的乘法逆元。

#### 4. 逆元的计算方法

##### 4.1 拓展欧几里得（通用）

$$
ab \equiv 1 \pmod p \Leftrightarrow ab = 1 + kp \Leftrightarrow ab - kp = 1
$$

把 $b$ 换成 $x$，$-k$ 换成 $y$，得到

$$
ax + py = 1
$$


解得的正整数 $x$ 即为 $a$ 在模 $p$ 下的逆元。

c++参考代码

```c++
using ll = long long;
// 拓展欧几里得
ll exgcd(ll a, ll b, ll &x, ll &y) {
    if (b == 0) {
        x = 1;
        y = 0;
        return a;
    }
    ll res = exgcd(b, a % b, x, y);
    ll tmp = x;
    x = y;
    y = tmp - (a / b) * y;
    return res;
}
ll inv(ll a, ll p) {
    ll x, y;
    ll gcd_res = exgcd(a, p, x, y);
    if (gcd_res != 1) return -1;    // 没有逆元
    return ((x % p) + p) % p;
}
```

##### 4.2 费马小定理（p 为质数）

费马小定理：

> 如果 $p$ 是一个质数，$a$ 是一个整数且不能被 $p$ 整除（即 $a$ 与 $p$ 互质），那么有 $a^{p-1} \equiv 1 \pmod{p}$。换句话说，当一个整数 $a$ 与质数 $p$ 互质时，$a$ 的p-1次方除以 $p$ 的余数是1

由费马小定理可得 $a \times a^{p-2} \equiv 1 \pmod{p}$,因此 $a$ 在模 $p$ 意义下的一个逆元是 $a^{p-2}$，用**快速幂**可快速计算出。

c++参考代码

```c++
using ll = long long;
ll quick_pow(ll a, ll n, ll m) {   // 计算 (a ^ n) mod m
    ll res = 1;
    while (n) {
        if (n & 1) res = (res * a) % m;
        a = (a * a) % m;
        n >>= 1;
    }
    return res;
}
ll inv(ll a, ll p) { // 计算 a 在模 p 意义下的逆元，p 为素数
    return quick_pow(a, p - 2, p);
}
```

##### 4.3 线性递推、记忆化搜索（p 为素数）

设 $p = aq + r$，其中 $r = p \bmod a$，则 $q = \lfloor \frac{p}{a} \rfloor$

在模 $p$ 意义下，有 

$$
aq + r \equiv 0 \pmod{p}
$$


$$
\Downarrow
$$

$$
a = -r \times inv(q) \pmod{p}
$$

$$
\Downarrow
$$

$$
inv(a) = -q \times inv(r) \pmod{p}
$$

$$
\Downarrow
$$

$$
inv(a) = -\lfloor \frac{p}{a} \rfloor \times inv(p \bmod a) \pmod{p}
$$

线性递推c++参考代码

```c++
// Times of testing: 1
// inv[i]: i 在模 p 意义下的逆元，p 要为素数
vector<ll> inverse_element_init(int n, int p) {
    vector<ll> inv(n + 1);
    for (int i = 0; i <= n; i++) inv[i] = 0;
    inv[1] = 1;
    for (int i = 2; i <= n; i++) {
        inv[i] = (((-p / i * inv[p % i]) % p) + p) % p;
    }
    return inv;
}
```

#### 5. 阶乘的逆元

在模 $p$ 意义下，$a$ 的逆元和 $a \bmod p$ 的逆元是相等的，这是因为模 $p$ 的逆元是基于同余关系的，而同余关系满足以下性质：

* 如果 $a \equiv b \pmod p$，则 $a$ 和 $b$ 在模 $p$ 意义下的逆元是相等的。

显然，$a \bmod p \equiv (a \bmod p) \bmod p$，因此 $a$ 和 $a \bmod p$ 在模 $p$ 意义下的逆元是相等的。因此在模 $p$ 意义下 

$$
inv(n!) \equiv inv(n! \bmod p) \pmod p
$$


##### 5.1 阶乘逆元线性递推（条件：$p$ 为素数且 $n < p$）

$$
n! \times inv(n!) \equiv 1 \pmod p
$$

$$
\Downarrow
$$

$$
(n-1)! \times n \times inv(n!) \equiv 1 \pmod p
$$

由此得到递推公式：$inv((n-1)!) \equiv n \times inv(n!) \bmod p \pmod p$
